<div class="fixed inset-0 z-[100] flex items-center justify-center p-4">
  <!-- Backdrop -->
  <div
    class="absolute inset-0 bg-black/60 backdrop-blur-sm"
    (click)="onClose()"
    (keydown.escape)="onClose()"
    tabindex="0"
  ></div>

  <!-- Modal Container -->
  <div
    class="relative bg-cream rounded-none shadow-2xl w-full max-w-md p-8 md:p-10 transform transition-all"
  >
    <!-- Close Button -->
    <button
      (click)="onClose()"
      class="absolute top-4 right-4 text-primary hover:text-accent transition-colors"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-6 h-6"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M6 18L18 6M6 6l12 12"
        />
      </svg>
    </button>

    <!-- Content -->
    <div class="text-center mb-8">
      <h2 class="text-3xl font-heading font-bold text-primary mb-2">
        {{
          currentView === 'login'
            ? 'Connexion'
            : currentView === 'register'
              ? 'Créer un Compte'
              : 'Mot de Passe Oublié'
        }}
      </h2>
      <div class="w-16 h-1 bg-accent mx-auto"></div>
    </div>

    <!-- Error Message -->
    @if (errorMessage()) {
      <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
        <p class="text-sm text-red-700">{{ errorMessage() }}</p>
      </div>
    }

    <!-- Success Message -->
    @if (successMessage()) {
      <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
        <p class="text-sm text-green-700">{{ successMessage() }}</p>
      </div>
    }

    <!-- Login Form -->
    @if (currentView === 'login') {
      <form (ngSubmit)="onLogin()" class="space-y-6" novalidate>
        <div>
          <label
            for="email"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Email</label
          >
          <input
            type="email"
            id="email"
            [(ngModel)]="loginData.email"
            name="email"
            required
            email
            #loginEmail="ngModel"
            class="w-full bg-white border border-gray-200 px-4 py-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans"
            [class.border-red-500]="
              (loginEmail.touched || submitted) && loginEmail.invalid
            "
            placeholder="votre@email.com"
          />
          @if ((loginEmail.touched || submitted) && loginEmail.invalid) {
            <div class="text-red-500 text-xs mt-1">
              @if (loginEmail.errors?.['required']) {
                L'email est requis
              }
              @if (loginEmail.errors?.['email']) {
                Format d'email invalide
              }
            </div>
          }
        </div>
        <div>
          <label
            for="password"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Mot de passe</label
          >
          <input
            type="password"
            id="password"
            [(ngModel)]="loginData.password"
            name="password"
            required
            #loginPassword="ngModel"
            class="w-full bg-white border border-gray-200 px-4 py-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans"
            [class.border-red-500]="
              (loginPassword.touched || submitted) && loginPassword.invalid
            "
            placeholder="••••••••"
          />
          @if ((loginPassword.touched || submitted) && loginPassword.invalid) {
            <div class="text-red-500 text-xs mt-1">
              Le mot de passe est requis
            </div>
          }
        </div>

        <div class="flex justify-end">
          <button
            type="button"
            (click)="switchView('forgot-password')"
            class="text-sm text-gray-500 hover:text-accent transition-colors"
          >
            Mot de passe oublié ?
          </button>
        </div>

        <button
          type="submit"
          [disabled]="isLoading || !isLoginFormValid"
          class="w-full bg-primary text-white font-heading font-medium uppercase tracking-widest py-4 hover:bg-zinc-800 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ isLoading ? 'Connexion...' : 'Se Connecter' }}
        </button>

        <div class="text-center text-sm text-gray-500 mt-6">
          Pas encore de compte ?
          <button
            type="button"
            (click)="switchView('register')"
            class="text-accent font-medium hover:text-primary transition-colors"
          >
            Créer un compte
          </button>
        </div>
      </form>
    }

    <!-- Register Form -->
    @if (currentView === 'register') {
      <form (ngSubmit)="onRegister()" class="space-y-6" novalidate>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label
              for="firstName"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Prénom</label
            >
            <input
              type="text"
              id="firstName"
              [(ngModel)]="registerData.firstName"
              name="firstName"
              required
              #firstName="ngModel"
              class="w-full bg-white border border-gray-200 px-4 py-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans"
              [class.border-red-500]="
                (firstName.touched || submitted) && firstName.invalid
              "
              placeholder="Jean"
            />
            @if ((firstName.touched || submitted) && firstName.invalid) {
              <div class="text-red-500 text-xs mt-1">Prénom requis</div>
            }
          </div>
          <div>
            <label
              for="lastName"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Nom</label
            >
            <input
              type="text"
              id="lastName"
              [(ngModel)]="registerData.lastName"
              name="lastName"
              required
              #lastName="ngModel"
              class="w-full bg-white border border-gray-200 px-4 py-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans"
              [class.border-red-500]="
                (lastName.touched || submitted) && lastName.invalid
              "
              placeholder="Dupont"
            />
            @if ((lastName.touched || submitted) && lastName.invalid) {
              <div class="text-red-500 text-xs mt-1">Nom requis</div>
            }
          </div>
        </div>
        <div>
          <label
            for="phone"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Téléphone</label
          >
          <div class="flex space-x-2">
            <div class="relative w-5/12">
              <select
                id="countryCode"
                [(ngModel)]="registerData.countryCode"
                name="countryCode"
                class="w-full bg-white border border-gray-200 p-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans appearance-none truncate pr-6"
              >
                @for (code of countryCodes; track code.code) {
                  <option [value]="code.dial_code">
                    {{ code.flag }} {{ code.name }} ({{ code.dial_code }})
                  </option>
                }
              </select>
              <div
                class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-400"
              >
                <svg
                  class="w-3 h-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  ></path>
                </svg>
              </div>
            </div>
            <div class="relative flex-1">
              <input
                type="tel"
                id="phone"
                [(ngModel)]="registerData.phone"
                name="phone"
                required
                #phone="ngModel"
                class="w-full bg-white border border-gray-200 px-4 py-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans"
                [class.border-red-500]="
                  (phone.touched || submitted) && phone.invalid
                "
                placeholder="XX XXX XXX"
              />
            </div>
          </div>
          @if ((phone.touched || submitted) && phone.invalid) {
            <div class="text-red-500 text-xs mt-1">Téléphone requis</div>
          }
        </div>
        <div>
          <label
            for="reg-email"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Email</label
          >
          <input
            type="email"
            id="reg-email"
            [(ngModel)]="registerData.email"
            name="email"
            required
            email
            #regEmail="ngModel"
            class="w-full bg-white border border-gray-200 px-4 py-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans"
            [class.border-red-500]="
              (regEmail.touched || submitted) && regEmail.invalid
            "
            placeholder="votre@email.com"
          />
          @if ((regEmail.touched || submitted) && regEmail.invalid) {
            <div class="text-red-500 text-xs mt-1">
              @if (regEmail.errors?.['required']) {
                L'email est requis
              }
              @if (regEmail.errors?.['email']) {
                Format d'email invalide
              }
            </div>
          }
        </div>
        <div>
          <label
            for="reg-password"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Mot de passe</label
          >
          <input
            type="password"
            id="reg-password"
            [(ngModel)]="registerData.password"
            name="password"
            required
            minlength="6"
            #regPassword="ngModel"
            class="w-full bg-white border border-gray-200 px-4 py-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans"
            [class.border-red-500]="
              (regPassword.touched || submitted) && regPassword.invalid
            "
            placeholder="••••••••"
          />
          @if ((regPassword.touched || submitted) && regPassword.invalid) {
            <div class="text-red-500 text-xs mt-1">
              @if (regPassword.errors?.['required']) {
                Le mot de passe est requis
              }
              @if (regPassword.errors?.['minlength']) {
                Le mot de passe doit contenir au moins 6 caractères
              }
            </div>
          }
        </div>

        <button
          type="submit"
          [disabled]="isLoading || !isRegisterFormValid"
          class="w-full bg-primary text-white font-heading font-medium uppercase tracking-widest py-4 hover:bg-zinc-800 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {{ isLoading ? 'Inscription...' : "S'inscrire" }}
        </button>

        <div class="text-center text-sm text-gray-500 mt-6">
          Déjà un compte ?
          <button
            type="button"
            (click)="switchView('login')"
            class="text-accent font-medium hover:text-primary transition-colors"
          >
            Se connecter
          </button>
        </div>
      </form>
    }

    <!-- Forgot Password Form -->
    @if (currentView === 'forgot-password') {
      <form (ngSubmit)="onForgotPassword()" class="space-y-6">
        <p class="text-gray-600 text-sm text-center mb-4">
          Entrez votre adresse email et nous vous enverrons un lien pour
          réinitialiser votre mot de passe.
        </p>

        <div>
          <label
            for="fp-email"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Email</label
          >
          <input
            type="email"
            id="fp-email"
            [(ngModel)]="forgotMwEmail"
            name="fpEmail"
            required
            class="w-full bg-white border border-gray-200 px-4 py-3 focus:outline-none focus:border-accent transition-colors text-primary font-sans"
            placeholder="votre@email.com"
          />
        </div>

        <button
          type="submit"
          class="w-full bg-primary text-white font-heading font-medium uppercase tracking-widest py-4 hover:bg-zinc-800 transition-colors duration-300"
        >
          Envoyer le lien
        </button>

        <div class="text-center text-sm text-gray-500 mt-6">
          <button
            type="button"
            (click)="switchView('login')"
            class="text-accent font-medium hover:text-primary transition-colors flex items-center justify-center w-full"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-4 h-4 mr-2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"
              />
            </svg>
            Retour à la connexion
          </button>
        </div>
      </form>
    }
  </div>
</div>
