<nav class="bg-cream shadow-sm sticky top-0 z-50 font-sans">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-20">
      <!-- Logo -->
      <div class="flex items-center">
        <a
          routerLink="/"
          class="text-3xl font-heading font-bold text-primary flex items-center tracking-wide"
        >
          L'ARTISTOU MEUBLE
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center space-x-8">
        <a
          routerLink="/"
          class="text-sm uppercase tracking-widest font-medium text-primary hover:text-accent transition-colors"
        >
          Accueil
        </a>
        <div class="relative h-full flex items-center group">
          <button
            (click)="toggleCategoriesDropdown($event)"
            class="text-sm uppercase tracking-widest font-medium text-primary hover:text-accent transition-colors flex items-center"
          >
            Nos Catégories
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-4 h-4 ml-1 transform transition-transform group-hover:rotate-180"
              [class.rotate-180]="isCategoriesDropdownOpen"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="m19.5 8.25-7.5 7.5-7.5-7.5"
              />
            </svg>
          </button>

          <!-- Shadow/Overlay for hover effect stability -->
          <div class="absolute top-full left-0 w-full h-4"></div>

          <!-- Categories Dropdown (Mega Menu Style) -->
          <div
            class="absolute top-[calc(100%-1px)] left-1/2 -translate-x-1/2 w-[800px] bg-white shadow-2xl border-t border-accent/20 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-[60]"
            [class.!opacity-100]="isCategoriesDropdownOpen"
            [class.!visible]="isCategoriesDropdownOpen"
          >
            <div class="p-8">
              <div
                class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100"
              >
                <h3 class="text-xl font-heading font-bold text-primary">
                  Explorez nos univers
                </h3>
              </div>

              <div class="grid grid-cols-4 gap-6">
                @for (cat of categories(); track cat.id) {
                  <a
                    [routerLink]="['/category', cat.slug]"
                    (click)="closeDropdowns()"
                    class="group/item flex flex-col space-y-3 p-3 hover:bg-cream-light transition-colors duration-300"
                  >
                    <div
                      class="aspect-square overflow-hidden bg-gray-50 flex items-center justify-center"
                    >
                      @if (cat.image) {
                        <img
                          [src]="cat.image"
                          [alt]="cat.name"
                          class="w-full h-full object-cover group-hover/item:scale-110 transition-transform duration-500"
                        />
                      } @else {
                        <div class="text-accent/30">
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke-width="1"
                            stroke="currentColor"
                            class="w-12 h-12"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"
                            />
                          </svg>
                        </div>
                      }
                    </div>
                    <div class="text-center">
                      <p
                        class="text-sm font-heading font-semibold text-primary uppercase tracking-wide group-hover/item:text-accent transition-colors"
                      >
                        {{ cat.name }}
                      </p>
                      <p
                        class="text-[12px] text-gray-400 uppercase tracking-tighter"
                      >
                        {{ cat._count?.products || 0 }} Articles
                      </p>
                    </div>
                  </a>
                }
              </div>
            </div>
          </div>
        </div>
        <a
          routerLink="/packs"
          class="text-sm uppercase tracking-widest font-medium text-primary hover:text-accent transition-colors"
        >
          Pack Mariage
        </a>
        <a
          routerLink="/contact"
          class="text-sm uppercase tracking-widest font-medium text-primary hover:text-accent transition-colors"
        >
          Contact
        </a>
      </div>

      <!-- Icons & Mobile Menu Button -->
      <div class="flex items-center space-x-5 md:space-x-6">
        <!-- Search -->
        <button
          (click)="openSearchModal()"
          class="text-primary hover:text-accent transition-colors"
        >
          <span class="sr-only">Search</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"
            />
          </svg>
        </button>

        <!-- Cart -->
        <a
          routerLink="/cart"
          class="text-primary hover:text-accent transition-colors relative"
        >
          <span class="sr-only">Cart</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z"
            />
          </svg>
          @if (cartCount() > 0) {
            <span
              class="absolute -top-2 -right-2 bg-accent text-white text-[10px] font-bold h-4 w-4 rounded-full flex items-center justify-center animate-bounce-short"
            >
              {{ cartCount() }}
            </span>
          }
        </a>

        <!-- User Actions (Desktop) -->
        <div class="hidden md:block">
          @if (currentUser()) {
            <!-- User Dropdown -->
            <div class="relative">
              <button
                (click)="toggleUserDropdown()"
                class="flex items-center space-x-2 text-primary hover:text-accent transition-colors focus:outline-none"
              >
                <span class="sr-only">User Menu</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="w-6 h-6"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"
                  />
                </svg>
              </button>

              <!-- Dropdown Menu -->
              @if (isUserDropdownOpen) {
                <div
                  class="absolute right-0 mt-4 w-56 bg-white shadow-xl rounded-none py-2 z-50 border border-gray-100"
                >
                  <div class="px-6 py-3 border-b border-gray-100 mb-2">
                    <p class="text-sm font-medium text-primary">
                      {{ currentUser()?.firstName }}
                      {{ currentUser()?.lastName }}
                    </p>
                    <p class="text-xs text-gray-500 truncate">
                      {{ currentUser()?.email }}
                    </p>
                  </div>

                  <a
                    routerLink="/profile"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-cream-light transition-colors font-bold uppercase tracking-widest text-[10px]"
                  >
                    Mon Profil
                  </a>
                  <a
                    routerLink="/profile/orders"
                    class="block px-4 py-2 text-sm text-gray-700 hover:bg-cream-light transition-colors font-bold uppercase tracking-widest text-[10px]"
                  >
                    Mes Commandes
                  </a>

                  @if (currentUser()?.role === 'ADMIN') {
                    <a
                      routerLink="/admin"
                      class="block px-4 py-2 text-sm text-accent hover:bg-cream-light transition-colors font-bold uppercase tracking-widest text-[10px]"
                    >
                      Administration
                    </a>
                  }

                  <div class="border-t border-gray-100 mt-2 pt-2">
                    <button
                      (click)="logout()"
                      class="block w-full text-left px-6 py-2 text-sm text-red-500 hover:bg-red-50 transition-colors"
                    >
                      Déconnexion
                    </button>
                  </div>
                </div>
              }
            </div>
          } @else {
            <button
              (click)="openAuthModal()"
              class="text-sm uppercase tracking-widest font-medium text-primary hover:text-accent transition-colors"
            >
              Log in
            </button>
          }
        </div>

        <!-- Mobile Menu Toggle Button -->
        <button
          (click)="toggleMobileMenu()"
          class="md:hidden text-primary p-2 -mr-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-8 h-8"
          >
            @if (!isMobileMenuOpen) {
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"
              />
            } @else {
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6 18 18 6M6 6l12 12"
              />
            }
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu Overlay -->
  <div
    class="md:hidden fixed inset-0 z-40 bg-white transform transition-transform duration-300 ease-in-out pt-20"
    [class.translate-x-full]="!isMobileMenuOpen"
    [class.translate-x-0]="isMobileMenuOpen"
  >
    <div
      class="px-6 py-8 space-y-12 overflow-y-auto h-full pb-32 flex flex-col items-center"
    >
      <!-- Main Nav -->
      <div class="flex flex-col space-y-8 items-center pt-8">
        <a
          routerLink="/"
          (click)="closeMobileMenu()"
          class="text-2xl font-heading font-bold text-primary uppercase tracking-widest"
          >Accueil</a
        >
        <a
          routerLink="/packs"
          (click)="closeMobileMenu()"
          class="text-2xl font-heading font-bold text-primary uppercase tracking-widest"
          >Pack Mariage</a
        >
        <a
          routerLink="/contact"
          (click)="closeMobileMenu()"
          class="text-2xl font-heading font-bold text-primary uppercase tracking-widest"
          >Contact</a
        >
      </div>

      <!-- Categories Accordion/List -->
      <div
        class="pt-8 border-t border-gray-100 w-full flex flex-col items-center"
      >
        <h4
          class="text-sm font-heading font-bold text-accent uppercase tracking-widest mb-8 text-center"
        >
          Nos Catégories
        </h4>
        <div class="flex flex-col space-y-6 items-center w-full">
          @for (cat of categories(); track cat.id) {
            <a
              [routerLink]="['/category', cat.slug]"
              (click)="closeMobileMenu()"
              class="flex flex-col items-center group py-1"
            >
              <span
                class="text-lg font-heading font-medium uppercase tracking-widest text-primary group-hover:text-accent transition-colors"
                >{{ cat.name }}</span
              >
              <div
                class="h-0.5 w-0 group-hover:w-full bg-accent transition-all duration-300"
              ></div>
            </a>
          }
        </div>
      </div>

      <!-- User Actions Mobile -->
      <div
        class="pt-8 border-t border-gray-100 flex flex-col items-center space-y-6 w-full"
      >
        @if (currentUser()) {
          <div
            class="bg-cream-light p-6 flex flex-col items-center space-y-3 w-full max-w-xs"
          >
            <div
              class="h-12 w-12 bg-accent text-white rounded-full flex items-center justify-center font-bold text-lg"
            >
              {{ currentUser()?.firstName?.[0]
              }}{{ currentUser()?.lastName?.[0] }}
            </div>
            <div class="text-center">
              <p class="text-base font-bold text-primary">
                {{ currentUser()?.firstName }} {{ currentUser()?.lastName }}
              </p>
              <p class="text-xs text-gray-500">{{ currentUser()?.email }}</p>
            </div>
          </div>
          <a
            routerLink="/client/orders"
            (click)="closeMobileMenu()"
            class="text-sm font-bold text-primary uppercase tracking-widest py-2"
            >Mon Espace</a
          >
          @if (currentUser()?.role === 'ADMIN') {
            <a
              routerLink="/admin"
              (click)="closeMobileMenu()"
              class="text-sm font-bold text-accent uppercase tracking-widest py-2"
              >Administration</a
            >
          }
          <button
            (click)="logout(); closeMobileMenu()"
            class="text-sm font-bold text-red-500 uppercase tracking-widest py-2"
          >
            Déconnexion
          </button>
        } @else {
          <button
            (click)="openAuthModal(); closeMobileMenu()"
            class="bg-primary text-white text-sm font-bold uppercase tracking-widest py-4 px-12 w-full max-w-xs shadow-lg"
          >
            Se Connecter
          </button>
        }
      </div>
    </div>
  </div>
</nav>

@if (isAuthModalOpen()) {
  <app-auth-modal (closeModal)="closeAuthModal()"></app-auth-modal>
}

@if (isSearchModalOpen) {
  <app-search-modal (closeModal)="closeSearchModal()"></app-search-modal>
}
