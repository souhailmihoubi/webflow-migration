<div class="p-8">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900">Gestion des Commandes</h1>
    <p class="text-gray-500 mt-2">
      Gérez et suivez toutes les commandes clients
    </p>
  </div>

  <!-- Filters Section -->
  <div class="bg-white rounded-lg shadow p-6 mb-6 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Search by name -->
      <div>
        <label
          for="search-input"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Rechercher
        </label>
        <input
          id="search-input"
          type="text"
          [value]="searchTerm()"
          (input)="onSearchChange($event)"
          placeholder="Nom, email, ville, téléphone..."
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          aria-label="Rechercher une commande"
        />
      </div>

      <!-- Status filter -->
      <div>
        <label
          for="status-filter"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Statut
        </label>
        <select
          id="status-filter"
          [value]="statusFilter()"
          (change)="onStatusFilterChange($event)"
          aria-label="Filtrer par statut"
          class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-accent outline-none"
        >
          <option value="ALL">Tous les statuts</option>
          <option value="PENDING">En attente</option>
          <option value="CONFIRMED">Confirmée</option>
          <option value="DELIVERED">Livrée</option>
          <option value="CANCELLED">Annulée</option>
        </select>
      </div>

      <!-- Date range - Start -->
      <div>
        <label
          for="start-date"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Date début
        </label>
        <input
          id="start-date"
          type="date"
          [value]="startDate()"
          (change)="onDateChange('start', $event)"
          aria-label="Date de début"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-accent outline-none"
        />
      </div>

      <!-- Date range - End -->
      <div>
        <label
          for="end-date"
          class="block text-sm font-medium text-gray-700 mb-2"
        >
          Date fin
        </label>
        <input
          id="end-date"
          type="date"
          class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
      </div>
    </div>

    <!-- Filter actions -->
    <div class="flex items-center justify-between pt-4 border-t">
      <div class="text-sm text-gray-600">
        <span class="font-semibold">{{ totalItems() }}</span> commande(s)
      </div>
      <button
        (click)="clearFilters()"
        class="text-sm text-blue-600 hover:text-blue-700 font-medium"
      >
        Réinitialiser les filtres
      </button>
    </div>
  </div>

  <!-- Orders Table -->
  @if (isLoading()) {
    <div class="flex justify-center items-center py-12">
      <div
        class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"
      ></div>
    </div>
  } @else if (orders().length === 0) {
    <div class="bg-white rounded-lg shadow p-12 text-center">
      <svg
        class="mx-auto h-12 w-12 text-gray-400"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
        />
      </svg>
      <p class="text-gray-500 text-lg mt-4">Aucune commande trouvée</p>
      @if (
        searchTerm() || statusFilter() !== 'ALL' || startDate() || endDate()
      ) {
        <button
          (click)="clearFilters()"
          class="mt-4 text-blue-600 hover:text-blue-700 font-medium"
        >
          Effacer les filtres
        </button>
      }
    </div>
  } @else {
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                N° Commande
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Client
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Ville
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Téléphone
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Prix Total
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Date
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Statut
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            @for (order of orders(); track order.id) {
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">
                    #{{ order.orderNumber || order.id.slice(0, 8) }}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">
                    {{ order.firstName + ' ' + order.lastName || 'N/A' }}
                  </div>
                  <div class="text-sm text-gray-500">
                    {{ order.email || '' }}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">
                    {{ order.city || 'N/A' }}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">
                    {{ order.phone || 'N/A' }}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-semibold text-gray-900">
                    {{ formatPrice(order.totalPrice) }}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-500">
                    {{ formatDate(order.createdAt) }}
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span
                    class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                    [class]="getStatusClass(order.status)"
                  >
                    {{ getStatusLabel(order.status) }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                  <div class="flex items-center gap-2">
                    <button
                      (click)="viewOrderDetails(order)"
                      class="text-blue-600 hover:text-blue-700 font-medium"
                    >
                      Détails
                    </button>
                    <select
                      [value]="order.status"
                      (change)="
                        updateStatus(
                          order.id,
                          $any($event.target).value,
                          order.orderNumber || order.id.slice(0, 8)
                        )
                      "
                      [disabled]="isUpdating() === order.id"
                      class="border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      @for (status of statuses; track status) {
                        <option [value]="status">
                          {{ getStatusLabel(status) }}
                        </option>
                      }
                    </select>
                    @if (isUpdating() === order.id) {
                      <span class="ml-2 text-xs text-gray-500"
                        >Mise à jour...</span
                      >
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <app-pagination
        [currentPage]="currentPage()"
        [itemsPerPage]="itemsPerPage()"
        [totalItems]="totalItems()"
        (pageChange)="onPageChange($event)"
      ></app-pagination>
    </div>
  }

  <!-- Order Details Modal -->
  @if (showDetailsModal() && selectedOrder()) {
    <div
      class="fixed inset-0 z-50 overflow-y-auto"
      (click)="closeDetailsModal()"
      (keyup.escape)="closeDetailsModal()"
      tabindex="0"
    >
      <div
        class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0"
      >
        <!-- Background overlay -->
        <div
          class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75"
        ></div>

        <!-- Modal panel -->
        <div
          class="relative inline-block w-full max-w-4xl px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:p-6"
          (click)="$event.stopPropagation()"
          (keyup)="$event.stopPropagation()"
          tabindex="-1"
        >
          <!-- Header -->
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">
              Détails de la commande #{{
                selectedOrder().orderNumber || selectedOrder().id.slice(0, 8)
              }}
            </h3>
            <button
              (click)="closeDetailsModal()"
              class="text-gray-400 hover:text-gray-500"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Customer Information -->
            <div class="bg-gray-50 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">
                Informations Client
              </h4>
              <div class="space-y-2">
                <div>
                  <span class="text-sm font-medium text-gray-500">Nom:</span>
                  <p class="text-sm text-gray-900">
                    {{
                      (selectedOrder().firstName || '') +
                        ' ' +
                        (selectedOrder().lastName || '') || 'N/A'
                    }}
                  </p>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-500">Email:</span>
                  <p class="text-sm text-gray-900">
                    {{ selectedOrder().email || 'N/A' }}
                  </p>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-500"
                    >Téléphone:</span
                  >
                  <p class="text-sm text-gray-900">
                    {{ selectedOrder().phone || 'N/A' }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Shipping Address -->
            <div class="bg-gray-50 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">
                Adresse de Livraison
              </h4>
              <div class="space-y-2">
                <div>
                  <span class="text-sm font-medium text-gray-500"
                    >Adresse:</span
                  >
                  <p class="text-sm text-gray-900">
                    {{ selectedOrder().shippingAddress || 'N/A' }}
                  </p>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-500">Ville:</span>
                  <p class="text-sm text-gray-900">
                    {{ selectedOrder().city || 'N/A' }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Order Information -->
            <div class="bg-gray-50 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">
                Informations Commande
              </h4>
              <div class="space-y-2">
                <div>
                  <span class="text-sm font-medium text-gray-500">Date:</span>
                  <p class="text-sm text-gray-900">
                    {{ formatDate(selectedOrder().createdAt) }}
                  </p>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-500">Statut:</span>
                  <p>
                    <span
                      class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                      [class]="getStatusClass(selectedOrder().status)"
                    >
                      {{ getStatusLabel(selectedOrder().status) }}
                    </span>
                  </p>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-500"
                    >Mode de paiement:</span
                  >
                  <p class="text-sm text-gray-900 font-medium">
                    @if (selectedOrder().paymentMethod === 'COD') {
                      Paiement à la livraison
                    } @else if (
                      selectedOrder().paymentMethod === 'BANK_TRANSFER'
                    ) {
                      Virement Bancaire
                    } @else {
                      {{ selectedOrder().paymentMethod || 'N/A' }}
                    }
                  </p>
                  @if (
                    selectedOrder().paymentMethod === 'BANK_TRANSFER' &&
                    selectedOrder().paymentPlan
                  ) {
                    <p class="text-xs text-blue-600 mt-1">
                      @if (selectedOrder().paymentPlan === 'FULL') {
                        (Paiement Total - 100%)
                      } @else if (
                        selectedOrder().paymentPlan === 'DEPOSIT_50'
                      ) {
                        (Avance 50% + 50% à la livraison)
                      }
                    </p>
                  }
                </div>
              </div>
            </div>

            <!-- Price Summary -->
            <div class="bg-gray-50 rounded-lg p-4">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">
                Résumé des Prix
              </h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-sm font-medium text-gray-500"
                    >Sous-total:</span
                  >
                  <p class="text-sm text-gray-900">
                    {{
                      formatPrice(
                        selectedOrder().subtotal || selectedOrder().totalPrice
                      )
                    }}
                  </p>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm font-medium text-gray-500"
                    >Livraison:</span
                  >
                  <p class="text-sm text-gray-900">
                    {{ formatPrice(selectedOrder().shippingCost || 0) }}
                  </p>
                </div>
                <div class="flex justify-between pt-2 border-t border-gray-200">
                  <span class="text-base font-semibold text-gray-900"
                    >Total:</span
                  >
                  <p class="text-base font-bold text-gray-900">
                    {{ formatPrice(selectedOrder().totalPrice) }}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Order Items -->
          <div class="mt-6">
            <h4 class="text-lg font-semibold text-gray-900 mb-4">
              Articles Commandés
            </h4>
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Produit
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Quantité
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Prix Unitaire
                    </th>
                    <th
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Total
                    </th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  @for (item of selectedOrder().items; track item.id) {
                    <tr>
                      <td class="px-4 py-3">
                        <div class="flex items-center">
                          @if (item.product?.mainImage) {
                            <img
                              [src]="item.product.mainImage"
                              [alt]="
                                item.product?.name ||
                                item.pack?.name ||
                                'Product Image'
                              "
                              class="w-12 h-12 object-cover rounded mr-3"
                            />
                          }
                          <div>
                            <p class="text-sm font-medium text-gray-900">
                              {{
                                item.product?.name || item.pack?.name || 'N/A'
                              }}
                            </p>
                            @if (item.pack) {
                              <p class="text-xs text-gray-500">Pack</p>
                            }
                          </div>
                        </div>
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-900">
                        {{ item.quantity }}
                      </td>
                      <td class="px-4 py-3 text-sm text-gray-900">
                        {{ formatPrice(item.priceAtTime) }}
                      </td>
                      <td class="px-4 py-3 text-sm font-medium text-gray-900">
                        {{ formatPrice(item.priceAtTime * item.quantity) }}
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>

          <!-- Footer -->
          <div class="mt-6 flex justify-end">
            <button
              (click)="closeDetailsModal()"
              class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
